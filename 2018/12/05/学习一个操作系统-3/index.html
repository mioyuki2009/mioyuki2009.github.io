<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>学习一个操作系统-3 | waterpool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="继续上次的">
<meta property="og:type" content="article">
<meta property="og:title" content="学习一个操作系统-3">
<meta property="og:url" content="http://mioswaterpool.xyz/2018/12/05/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-3/index.html">
<meta property="og:site_name" content="waterpool">
<meta property="og:description" content="继续上次的">
<meta property="og:locale">
<meta property="og:image" content="http://mioswaterpool.xyz/images/sad.jpg">
<meta property="article:published_time" content="2018-12-05T06:53:39.000Z">
<meta property="article:modified_time" content="2022-07-23T03:12:46.275Z">
<meta property="article:author" content="mioyuki2009">
<meta property="article:tag" content="linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://mioswaterpool.xyz/images/sad.jpg">
    

    

    

    
<link rel="stylesheet" href="/libs/font-awesome5/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/libs/font-awesome5/css/fa-brands.min.css">

    
<link rel="stylesheet" href="/libs/font-awesome5/css/fa-solid.min.css">

    
<link rel="stylesheet" href="/libs/open-sans/styles.css">

    
<link rel="stylesheet" href="/libs/source-code-pro/styles.css">


    
<link rel="stylesheet" href="/css/style.css">


    
<script src="/libs/jquery/2.1.3/jquery.min.js"></script>

    
    
        
<link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">

    
    
        
<link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">

    
    
    
    


<meta name="generator" content="Hexo 6.2.0"></head>

<script type="text/javascript" src="/js/clicklove.js"></script>
<body>
	
		<style>
			body{
				cursor: url(/zzimages/normal.cur), auto;
			}
			a {
				cursor: url(/zzimages/normal.cur), auto;
			}
		</style>
	
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">waterpool</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/goniko.jpg" />
                            <i class="fas fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fas fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>


</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile" class="profile-fixed">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/goniko.jpg" />
            <h2 id="name">mioyuki2009</h2>
            <h3 id="title">salt fish</h3>
            <span id="location"><i class="fas fa-map-marker-alt" style="padding-right: 5px"></i>WuHan, China</span>
            <a id="follow" target="_blank" href="https://github.com/mioyuki2009">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                35
                <span>posts</span>
            </div>
            <div class="article-info-block">
                4
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/mioyuki2009" target="_blank" title="github" class=tooltip>
                            <i class="fab fa-github"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-学习一个操作系统-3" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            学习一个操作系统-3
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fas fa-calendar-alt"></i>
        <a href="/2018/12/05/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-3/">
            <time datetime="2018-12-05T06:53:39.000Z" itemprop="datePublished">2018-12-05</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fas fa-folder"></i>
        <a class="article-category-link" href="/categories/os/">os</a>
    </div>

                        
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/linux/" rel="tag">linux</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>继续上次的</p>
<span id="more"></span>
<p>这次实现一个保护模式，全部代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">%include &quot;pm.inc&quot;</span><br><span class="line"></span><br><span class="line">org 07c00h</span><br><span class="line">    jmp     LABEL_BEGIN</span><br><span class="line"></span><br><span class="line">[SECTION .gdt]</span><br><span class="line">; GDT</span><br><span class="line">;                             段基址             段界限  属性                </span><br><span class="line">LABEL_GDT:        Descriptor       0,                0, 0           ;空描述符</span><br><span class="line">LABEL_DESC_CODE32:Descriptor       0, SegCode32Len - 1, DA_C + DA_32;非一致代码段</span><br><span class="line">LABEL_DESC_VIDEO: Descriptor 0B8000h,           0ffffh, DA_DRW      ;显存首地址</span><br><span class="line">; GDT结束</span><br><span class="line"></span><br><span class="line">GdtLen      equ     $ - LABEL_GDT   ;GDT长度</span><br><span class="line">GdtPtr      dw      GdtLen - 1      ;GDT界限</span><br><span class="line">            dd      0               ;GDT基地址</span><br><span class="line"></span><br><span class="line">; GDT选择子</span><br><span class="line">SelectorCode32      equ     LABEL_DESC_CODE32       - LABEL_GDT</span><br><span class="line">SelectorVideo       equ     LABEL_DESC_VIDEO        - LABEL_GDT</span><br><span class="line">; END of [SECTION .gdt]</span><br><span class="line"></span><br><span class="line">[SECTION .a16]</span><br><span class="line">[BITS 16]</span><br><span class="line">LABEL_BEGIN:</span><br><span class="line">    mov     ax, cs</span><br><span class="line">    mov     ds, ax</span><br><span class="line">    mov     es, ax</span><br><span class="line">    mov     ss, ax</span><br><span class="line">    mov     sp, 0100h</span><br><span class="line"></span><br><span class="line">    ; 初始化32位代码段描述符</span><br><span class="line">    xor     eax, eax</span><br><span class="line">    mov     ax, cs</span><br><span class="line">    shl     eax, 4</span><br><span class="line">    add     eax, LABEL_SEG_CODE32</span><br><span class="line">    mov     word [LABEL_DESC_CODE32 + 2], ax</span><br><span class="line">    shr     eax, 16</span><br><span class="line">    mov     byte [LABEL_DESC_CODE32 + 4], al</span><br><span class="line">    mov     byte [LABEL_DESC_CODE32 + 7], ah</span><br><span class="line"></span><br><span class="line">    ; 为加载GDTR做准备</span><br><span class="line">    xor     eax, eax</span><br><span class="line">    mov     ax, ds</span><br><span class="line">    shl     eax, 4</span><br><span class="line">    add     eax, LABEL_GDT          ; eax &lt;- gdt 基地址</span><br><span class="line">    mov     dword [GdtPtr + 2], eax ; [GdtPtr + 2] &lt;- gdt 基地址</span><br><span class="line"></span><br><span class="line">    ; 加载 GDTR</span><br><span class="line">    lgdt    [GdtPtr]</span><br><span class="line"></span><br><span class="line">    ; 关中断</span><br><span class="line">    cli</span><br><span class="line"></span><br><span class="line">    ; 打开地址线A20</span><br><span class="line">    in      al, 92h</span><br><span class="line">    or      al, 00000010b</span><br><span class="line">    out     92h,al</span><br><span class="line"></span><br><span class="line">    ; 准备切换到保护模式</span><br><span class="line">    mov     eax, cr0</span><br><span class="line">    or      eax, 1</span><br><span class="line">    mov     cr0, eax</span><br><span class="line"></span><br><span class="line">    ; 真正进入保护模式</span><br><span class="line">    jmp dword SelectorCode32:0      ; 执行这一句会把SelectorCode32装入cs</span><br><span class="line">                                    ; 并跳转到Code32Selector:0处</span><br><span class="line">; END of [SECTION .s16]</span><br><span class="line"></span><br><span class="line">[SECTION .s32] ; 32位代码段， 由实模式跳入。</span><br><span class="line">[BITS 32]</span><br><span class="line"></span><br><span class="line">LABEL_SEG_CODE32:</span><br><span class="line">    mov     ax, SelectorVideo</span><br><span class="line">    mov     gs, ax                  ; 视频段选择子（目的）</span><br><span class="line"></span><br><span class="line">    mov     edi, (80 *11 + 79) * 2  ; 屏幕第11行，第79列。</span><br><span class="line">    mov     ah, 0Ch                 ; 0000: 黑底 1100:红字</span><br><span class="line">    mov     al, &#x27;p&#x27;</span><br><span class="line">    mov     [gs:edi], ax</span><br><span class="line"></span><br><span class="line">    ; 到此停止</span><br><span class="line">    jmp $</span><br><span class="line"></span><br><span class="line">SegCode32Len    equ     $ - LABEL_SEG_CODE32</span><br><span class="line">; END of [SECTION .s32]</span><br></pre></td></tr></table></figure>

<p>下面简单解释一下：<br>首先<code>include "pm.inc"</code>和注释一样，这里面包含一些常量，宏和相关说明，没有的可以在<a target="_blank" rel="noopener" href="https://github.com/yyu/osfs03/blob/master/f/pm.inc">这里</a>获取。</p>
<p>然后和之前一样<code>org 07c00h</code>，之后jmp到需要执行的代码。</p>
<p>现在看<code>[SECTION .gdt]</code>这个段，这里SECTION定义了一个gdt段，SECTION并没有什么特别的语义，仅仅是一种组织代码和存储的方式，这里这样做是为了之后很好的扩展，要了解更多可以查看<a target="_blank" rel="noopener" href="https://blog.csdn.net/ruyanhai/article/details/7179878">这个</a>。开始就用Descriptor定义了3个结构，Descriptor在”pm.inc”中定义，定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">; 宏 ------------------------------------------------------------------------------------------------------</span><br><span class="line">;</span><br><span class="line">; 描述符</span><br><span class="line">; usage: Descriptor Base, Limit, Attr</span><br><span class="line">;        Base:  dd</span><br><span class="line">;        Limit: dd (low 20 bits available)</span><br><span class="line">;        Attr:  dw (lower 4 bits of higher byte are always 0)</span><br><span class="line">%macro Descriptor 3</span><br><span class="line">	dw	%2 &amp; 0FFFFh				                ; 段界限 1				    (2 字节)</span><br><span class="line">	dw	%1 &amp; 0FFFFh				                ; 段基址 1				    (2 字节)</span><br><span class="line">	db	(%1 &gt;&gt; 16) &amp; 0FFh			            ; 段基址 2				    (1 字节)</span><br><span class="line">	dw	((%2 &gt;&gt; 8) &amp; 0F00h) | (%3 &amp; 0F0FFh)	    ; 属性 1 + 段界限 2 + 属性 2 (2 字节)</span><br><span class="line">	db	(%1 &gt;&gt; 24) &amp; 0FFh			            ; 段基址 3				    (1 字节)</span><br><span class="line">%endmacro ; 共 8 字节</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
<p>可以看到就是定义了一个8字节的结构，宏的语法格式为<code>%macro 宏名称 参数个数</code>，所以这里很明显了，就是定义了一个Descriptor，3参数的结构，之后的%1，%2，%3分别为第一个，第二个，第三个参数，之前也提到db，dw，dd分别为1字节，2字节，4字节，现在就可以分别解释了。<br>第一行表示取第二个参数的0-15位（2个字节的大小）作为宏的第一、二个字节<br>第二行表示取第一个参数的0-15位（2个字节的大小）作为宏的第三、四个字节<br>第三行先把第一个参数右移16位（2字节）最低位就变成了之前的第16位，在和0FF求与，就是取第一个参数的16-23位，作为宏的第五个字节。<br>第四行“|”号前半部分，参数2右移8位（1字节）最低为变为之前的第8位，和0F00求与，0F00为1的位置为第8-11位，在原始的第二个参数中就变成了16-19位（（8-11）+8）。后半部分第三个参数和0F0FF求与，就是第三个参数的0-7位及12-15位，之后前后部分求或得到宏的第六七字节，可以看到，这里的0-7位都是第三个参数的，所以认为宏的第六字节就是第三个参数的第0-7位，而第七字节就是这里的第8-15位就是两个参数的组合。<br>第五行第一个参数先右移24位，低位变成原来的第24位，然后与0FF求与，就是第一个参数的24-31位作为第宏的第八个字节。</p>
<p>ps：汇编语言中，一般所说的第一个字节是指按照存贮地址偏移量最小的字节，对应数据的最低位字节；而通信协议中，串行传输时，是从一个帧的首部开始依次传送，一般从高位数起；16位寄存器传输32位数值，根据32为数值的存储顺序，低位字在前，高位字在后，所以应该是先传低16位，后传高16位数据。</p>
<p>我们的代码中，这里的3个参数分别为段基址，段界限，属性，所以得到的宏的结构应该是这样的：<br><img src="/2018/12/05/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-3/1.png"></p>
<p>在IA32下，cpu有两种工作模式，实模式和保护模式，直观地看，当pc上电，开始时cpu是工作在实模式下的，经过某种机制后，才进入保护模式，在保护模式下，cpu有着巨大的寻址能力。Intel8086是16位的cpu，有16位的寄存器，16位的数据总线以及20位的地址总线和1MB的寻址能力。从80386开始，Intel的cpu进入32位时代。有32位地址总线，所以寻址空间可达4GB，这时需要新的方法来解决<br>8086是16位的cpu，只能访问地址在1M以下的内存称为常规内存，我们把地址在1M以上的内存称为扩展内存。实模式下有着16位的寄存器&#x2F;16位数据总线&#x2F;20位地址总线。一个地址有段和偏移两部分组成，物理地址的计算公式为：<br><b>物理地址physicaladdress&#x3D;段值segment * 16 + 偏移offset</b></p>
<p>其中段值和偏移都是16位的<br>从80386开始，进入32位cpu时代，有32位地址总线。但是，地址并没有用寄存器直接指定，仍然采用了“段+偏移”的模式。虽然段值仍然由原来的16位cs&#x2F;ds等寄存器指定，但此时这些寄存器中存放的不再是段基址，而是一个索引：从这个索引，可以找到一个表项，里面存放了段基址等很多属性，这个表项称为段描述符，这个表就称为GDT。这就是保护模式寻址了。<br>也就是说GDT的作用是用来提供段式存储机制，这种机制是通过段寄存器和GDT中的描述符（也就是我们这里的Descriptor）共同提供的。</p>
<p>所以，这里的3个参数，所谓的段基址就是存放该段的起始地址，而段界限指段内的最大偏移，所以一定要在段长度的基础上再减1，这就是这里SegCode32Len - 1的由来了，关于SegCode32Len，可以在代码最后看到<code>SegCode32Len equ $ - LABEL_SEG_CODE32</code>，所以SegCode32Len就是$ - LABEL_SEG_CODE32，而$表示的就是当前的偏移地址，而这一句是紧接着LABEL_SEG_CODE32之后的，<code>$ - LABEL_SEG_CODE32</code>就是表示他的长度了。关于他的属性很复杂，会在后面一点解释。</p>
<p>之后就是LABEL_DESC_VIDEO的描述子，关于这里的参数问题，可以看<a target="_blank" rel="noopener" href="https://blog.csdn.net/venlv2046/article/details/80260232">这里</a>。</p>
<p>之后又定义了两个结构，GdtLen作为Gdt长度，语义和之前说的SegCode32Len类似，GdtPtr结构，包含一个GDT界限和GDT基址。</p>
<p>然后是两个选择子SelectorCode32和SelectorVideo，具体的定义就是相应的描述符相对于GDT的偏移，再看代码就很直观了。</p>
<p>现在跳过16位的代码段，先看32位的代码段，这里的<code>[BITS 32]</code>指定了这一段的代码是32位代码段，即保护模式段：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov     ax, SelectorVideo</span><br><span class="line">mov     gs, ax </span><br></pre></td></tr></table></figure>
<p>这两句将段寄存器gs的值变成了SelectorVideo，由上面的解释可以看到SelectorVideo就是LABEL_DESC_VIDEO相对于GDT的偏移，这里GDT的基址为0，基本就可以认为gs现在就是对应显存的描述符LABEL_DESC_VIDEO。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov     edi, (80 *11 + 79) * 2  ; 屏幕第11行，第79列。</span><br><span class="line">mov     ah, 0Ch                 ; 0000: 黑底 1100:红字</span><br><span class="line">mov     al, &#x27;p&#x27;</span><br><span class="line">mov     [gs:edi], ax</span><br></pre></td></tr></table></figure>
<p>二三行分别指定了写入的字体和颜色分别写入ax的高低位，第一行就是就是位置了，这里通过计算在gs段偏移多少来设置地址，在屏幕上，一行一般是80个字符；每个字符的显示需要两个字节，一个字节是显示字符的ascii，一个字节的显示用的颜色（字符颜色+背景色）。这些数据在显示缓存里是按行排列的，先是第0行，然后是第1行，所以第11行的起始地址就是<code>80*2*11</code>了，这一行的第79列字符就是再加上<code>79*2</code>了，整个就是<code>80*2*11+79* 2=(80*11+79)*2</code>了。之后将ax的值写入这个位置就能达到显示的目的了。</p>
<p>现在来看16位的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov     ax, cs</span><br><span class="line">mov     ds, ax</span><br><span class="line">mov     es, ax</span><br><span class="line">mov     ss, ax</span><br><span class="line">mov     sp, 0100h</span><br></pre></td></tr></table></figure>
<p>首先是初始化相关段寄存器和对堆栈初始化，就是对ss和sp赋值了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">; 初始化32位代码段描述符</span><br><span class="line">xor     eax, eax</span><br><span class="line">mov     ax, cs</span><br><span class="line">shl     eax, 4</span><br><span class="line">add     eax, LABEL_SEG_CODE32</span><br><span class="line">mov     word [LABEL_DESC_CODE32 + 2], ax</span><br><span class="line">shr     eax, 16</span><br><span class="line">mov     byte [LABEL_DESC_CODE32 + 4], al</span><br><span class="line">mov     byte [LABEL_DESC_CODE32 + 7], ah</span><br></pre></td></tr></table></figure>
<p>eax就是ax的32位版本了。这段代码首先将LABEL_SEG_CODE32的物理地址（即[SECTION .s32]段的物理地址）赋给eax，然后把他分成三部分分别赋给描述符LABEL_DESC_CODE32的三个位置，不太理解的话可以与描述符的代码比较，这里的[LABEL_DESC_CODE32 + 2]相当于在LABEL_DESC_CODE32描述符之后的两个字节的位置，就是LABEL_DESC_CODE的三四字节，就是上图中段基址的位置，也是描述符代码中<code>dw %1 & 0FFFFh</code>这一行，shr eax, 16表示eax右移16位，之后同理，总之就是赋值了LABEL_DESC_CODE32描述符中段基址的部分。由于LABEL_DESC_CODE32段界限和属性已经指定，所以现在LABEL_DESC_CODE32的初始化已全部完成。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lgdt [GdtPtr]</span><br></pre></td></tr></table></figure>
<p>这一句的作用是将GdtPtr指示的6个字节加载到寄存器gdtr中，这里我们设计的GdtPtr和gdtr的结构完全一样。</p>
<p>下面一句话是关中断，之所以关中断，是因为保护模式下中断处理的机制是不同的，不关中断会出现错误。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; 打开地址线A20</span><br><span class="line">in      al, 92h</span><br><span class="line">or      al, 00000010b</span><br><span class="line">out     92h,al</span><br></pre></td></tr></table></figure>
<p>这一句是打开A20地址线。A20地址线并不是打开保护模式的关键，只是在保护模式下，不打开A20地址线，你将无法访问到所有的内存（具体参考下面的第5点）<br>1、用于80286与8086兼容<br>2、用于80286处于实模式下时，防止用户程序访问到100000h~10FFEFh之间的内存（高端内存）<br>3、8086模式，A20关闭的情况下，访问超过1MB内存时，会自动回卷<br>4、8086模式下，A20打开的情况下，访问超过1MB内存，就真实的访问<br>5、保护模式下，A20关闭（始终为0），则用户的地址只能是：0 - (1MB-1), 2 - (3MB-1), 4 - (5MB-1)，我们可以这样设想，A20为个位数（以1MB为单位），如果它始终为0，你永远不可能让这个数变成奇数<br>6、保护模式下，A20开启，则可以访问全地址，没有奇偶MB的问题。</p>
<p>这里的in和out语义分别是：</p>
<ul>
<li>in DES, SRC： 从src端口读取1字节数据到DES</li>
<li>OUT DES, SRC： 将SRC的值写入DES端口<br>打开A20地址线的方法有很多，这里我们使用操作端口92h的方法：<br>1、端口0x92控制A20信号线，即操作0x92端口就能开启和禁止寻址超过1M时的环绕。<br>2、or al,00000010b　就是将从端口0x92读入数据的二进制码的第二位置1，从而实现开启A20地址。因为A20信号的第二位就是用于控制开启&#x2F;禁止A20地址的。</li>
</ul>
<p>之后是切换到保护模式的准备工作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; 准备切换到保护模式</span><br><span class="line">mov     eax, cr0</span><br><span class="line">or      eax, 1</span><br><span class="line">mov     cr0, eax</span><br></pre></td></tr></table></figure>
<p>寄存器cr0的第0位是PE位，此位为0时，CPU运行于实模式，为1时，CPU运行于保护模式。这里将更改为1，就运行在保护模式下了。但是此时cs寄存器（代码段寄存器）的值仍然是实模式下的值，现在需要把代码段选择子装入cs中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">; 真正进入保护模式</span><br><span class="line">jmp dword SelectorCode32:0      ; 执行这一句会把SelectorCode32装入cs</span><br><span class="line">                                ; 并跳转到Code32Selector:0处</span><br></pre></td></tr></table></figure>
<p>之前说到SelectorCode32就是代码段选择子的地址，所以直接跳转就行，不过这里是16位的段，但是目标地址是32位的，所以加个dword变成32位的。</p>
<p>现在代码部分解释完毕，解释一下之前跳过的属性的部分吧：<br>关于描述符的简单格式这里只给一个图，详细一点的可以参考<a target="_blank" rel="noopener" href="http://www.cnblogs.com/longintchar/p/5224405.html">这个</a>。<br><img src="/2018/12/05/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-3/2.png"></p>
<p>我们这里的代码段的属性是<code>DA_C + DA_32</code>，这两个也是在pm.inc中定义的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">;----------------------------------------------------------------------------</span><br><span class="line">; 描述符类型值说明</span><br><span class="line">; 其中:</span><br><span class="line">;       DA_  : Descriptor Attribute</span><br><span class="line">;       D    : 数据段</span><br><span class="line">;       C    : 代码段</span><br><span class="line">;       S    : 系统段</span><br><span class="line">;       R    : 只读</span><br><span class="line">;       RW   : 读写</span><br><span class="line">;       A    : 已访问</span><br><span class="line">;       其它 : 可按照字面意思理解</span><br><span class="line">;----------------------------------------------------------------------------</span><br><span class="line">DA_32		EQU	4000h	; 32 位段</span><br><span class="line">DA_LIMIT_4K	EQU	8000h	; 段界限粒度为 4K 字节</span><br><span class="line"></span><br><span class="line">DA_DPL0		EQU	  00h	; DPL = 0</span><br><span class="line">DA_DPL1		EQU	  20h	; DPL = 1</span><br><span class="line">DA_DPL2		EQU	  40h	; DPL = 2</span><br><span class="line">DA_DPL3		EQU	  60h	; DPL = 3</span><br><span class="line">;----------------------------------------------------------------------------</span><br><span class="line">; 存储段描述符类型值说明</span><br><span class="line">;----------------------------------------------------------------------------</span><br><span class="line">DA_DR		EQU	90h	; 存在的只读数据段类型值</span><br><span class="line">DA_DRW		EQU	92h	; 存在的可读写数据段属性值</span><br><span class="line">DA_DRWA		EQU	93h	; 存在的已访问可读写数据段类型值</span><br><span class="line">DA_C		EQU	98h	; 存在的只执行代码段属性值</span><br><span class="line">DA_CR		EQU	9Ah	; 存在的可执行可读代码段属性值</span><br><span class="line">DA_CCO		EQU	9Ch	; 存在的只执行一致代码段属性值</span><br><span class="line">DA_CCOR		EQU	9Eh	; 存在的可执行可读一致代码段属性值</span><br><span class="line">;----------------------------------------------------------------------------</span><br><span class="line">; 系统段描述符类型值说明</span><br><span class="line">;----------------------------------------------------------------------------</span><br><span class="line">DA_LDT		EQU	  82h	; 局部描述符表段类型值</span><br><span class="line">DA_TaskGate	EQU	  85h	; 任务门类型值</span><br><span class="line">DA_386TSS	EQU	  89h	; 可用 386 任务状态段类型值</span><br><span class="line">DA_386CGate	EQU	  8Ch	; 386 调用门类型值</span><br><span class="line">DA_386IGate	EQU	  8Eh	; 386 中断门类型值</span><br><span class="line">DA_386TGate	EQU	  8Fh	; 386 陷阱门类型值</span><br><span class="line">;----------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>可以看到DA_C是98h，对应的二进制是10011000b。也就是说，P位是1表明这个段在内存中，S位是1表明这个段是代码段或者数据段，TYPE&#x3D;8表明这个段是个代码段，而且是只执行的代码段。DA_32是4000h，由于这个段是代码段，D位是1表明这个段是32位的代码段。所以这个段是存在的只执行的32位代码段，DPL为0。</p>
<p>现在代码部分解释完毕，是时候运行了。<br>和之前一样用nasm将代码编译为pmtest.bin，这里有点不同，之前我们是把bin文件直接写入到引导扇区，但是引导扇区空间有限，要是我们的程序之后大于512字节就不好了，所以现在有了另一个办法。步骤如下：<br>1、首先去<a target="_blank" rel="noopener" href="http://www.freedos.org/">freedos官网</a>下一个freedos的软盘img镜像，命名为freedos.img。<br>2、和之前一样用bximage生成一个软盘镜像，命名为pm.img<br>3、修改我们的bochsrc，将之前的floppya那一行更改为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">floppya: 1_44=freedos.img, status=inserted</span><br><span class="line">floppyb: 1_44=pm.img, status=inserted</span><br><span class="line">boot: a</span><br></pre></td></tr></table></figure>
<p>4、启动bochs，在freedos启动后格式化B:盘（<code>format b:</code>）。<br>5、因为现在要编译为.com文件，将代码<code>org 07c00h</code>更改为<code>org 0100h</code>进行编译：<code>nasm pmtest1.asm -o pmtest1.com</code><br>6、将pmtest1.com复制到虚拟软盘pm.img上：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -o loop pm.img /mnt/floppy</span><br><span class="line">sudo <span class="built_in">cp</span> pmtest1.com /mnt/floppy/</span><br><span class="line">sudo umount /mnt/floppy</span><br></pre></td></tr></table></figure>
<p>7、到freedos中执行如下命令：</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">B:\<span class="title">pmtest1.com</span></span></span><br></pre></td></tr></table></figure>
<p>如果成功可以看到如下所示的样子，一个红色的字母p出现在中间右侧：<br><img src="/2018/12/05/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-3/3.png"></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://mioswaterpool.xyz/2018/12/05/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-3/" data-id="cl5xh4mnl0033aguxabxx273n" class="article-share-link"><i class="fas fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fab fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fab fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fab fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fab fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
    
        <a href="/2018/12/04/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-2/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">Older</strong>
            <div class="article-nav-title">学习一个操作系统-2</div>
        </a>
    
</nav>


    
</article>


    
    

</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/12/05/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-3/" class="thumbnail">
    
    
        <span style="background-image:url(/images/sad.jpg)" alt="学习一个操作系统-3" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/os/">os</a></p>
                            <p class="item-title"><a href="/2018/12/05/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-3/" class="title">学习一个操作系统-3</a></p>
                            <p class="item-date"><time datetime="2018-12-05T06:53:39.000Z" itemprop="datePublished">2018-12-05</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/12/04/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-2/" class="thumbnail">
    
    
        <span style="background-image:url(/images/sad.jpg)" alt="学习一个操作系统-2" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/os/">os</a></p>
                            <p class="item-title"><a href="/2018/12/04/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-2/" class="title">学习一个操作系统-2</a></p>
                            <p class="item-date"><time datetime="2018-12-04T01:10:11.000Z" itemprop="datePublished">2018-12-04</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/12/03/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-1/" class="thumbnail">
    
    
        <span style="background-image:url(/images/sad.jpg)" alt="学习一个操作系统-1" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/os/">os</a></p>
                            <p class="item-title"><a href="/2018/12/03/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-1/" class="title">学习一个操作系统-1</a></p>
                            <p class="item-date"><time datetime="2018-12-03T01:19:01.000Z" itemprop="datePublished">2018-12-03</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/12/01/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AAvulkan-30-%E5%A4%9A%E9%87%8D%E9%87%87%E6%A0%B7/" class="thumbnail">
    
    
        <span style="background-image:url(/images/cat.jpg)" alt="学习一个vulkan(30)-多重采样" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/learn/">learn</a></p>
                            <p class="item-title"><a href="/2018/12/01/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AAvulkan-30-%E5%A4%9A%E9%87%8D%E9%87%87%E6%A0%B7/" class="title">学习一个vulkan(30)-多重采样</a></p>
                            <p class="item-date"><time datetime="2018-12-01T01:48:21.000Z" itemprop="datePublished">2018-12-01</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2018/11/30/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AAvulkan-29-%E7%94%9F%E6%88%90Mipmap/" class="thumbnail">
    
    
        <span style="background-image:url(/images/cat.jpg)" alt="学习一个vulkan(29)-生成Mipmap" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/learn/">learn</a></p>
                            <p class="item-title"><a href="/2018/11/30/%E5%AD%A6%E4%B9%A0%E4%B8%80%E4%B8%AAvulkan-29-%E7%94%9F%E6%88%90Mipmap/" class="title">学习一个vulkan(29)-生成Mipmap</a></p>
                            <p class="item-date"><time datetime="2018-11-30T01:11:41.000Z" itemprop="datePublished">2018-11-30</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">categories</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/learn/">learn</a><span class="category-list-count">31</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/os/">os</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/translate/">translate</a><span class="category-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">27</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/erlang/" rel="tag">erlang</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lisp/" rel="tag">lisp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vulkan/" rel="tag">vulkan</a><span class="tag-list-count">30</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tag cloud</h3>
        <div class="widget tagcloud">
            <a href="/tags/erlang/" style="font-size: 10px;">erlang</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/lisp/" style="font-size: 10px;">lisp</a> <a href="/tags/vulkan/" style="font-size: 20px;">vulkan</a>
        </div>
    </div>

    
    <div id="toTop" class="fas fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2022 mioyuki2009<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a target="_blank" rel="noopener" href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        


    
        
<script src="/libs/lightgallery/js/lightgallery.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-pager.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-zoom.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-hash.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-share.min.js"></script>

        
<script src="/libs/lightgallery/js/lg-video.min.js"></script>

    
    
        
<script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>

    
    



<!-- Custom Scripts -->

<script src="/js/main.js"></script>


    </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1.2,"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"react":{"opacity":0.9},"mobile":{"show":true},"log":false});</script></body>
</html>
