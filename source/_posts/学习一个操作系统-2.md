---
title: 学习一个操作系统-2
date: 2018-12-04 09:10:11
tags: linux
categories: os
thumbnail: /images/sad.jpg
---
继续上次的
<!-- more -->
上次是使用qemu进行模拟的，但是原书中使用的bochs，觉得还是保持一致比较好

首先安装bochs：
```bash
pacman -S bochs
```
然后输入命令进行软盘映像的创建：
```
bximage
```
得到下图所示：
![](学习一个操作系统-2\1.png)

第一个输入1，因为我们需要创建一个映像，第二个输入fd作为软盘创建，之后的输入默认就行，直接回车就行。
之后会在目录下得到一个a.img文件。现在可以将之前的引导扇区写入这个文件了：
```bash
dd if=boot.bin of=a.img bs=512 count=1 conv=notrunc
```
相比上一次多了一个conv参数，如果不用的话软盘映像文件会被截断（truncated），因为boot.bin比a.img要小。

之后需要实现一个bochs的配置文件bochsrc：
```bochsrc
megs=32

romimage: file=/usr/share/bochs/file=BIOS-bochs-latest
vgaromimage: file=/usr/share/bochs/VGABIOS-lgpl-latest

floppya: 1_44=a.img, status=inserted

log: bochsout.txt

mouse: enable=0

keyboard: keymap=/usr/share/bochs/keymaps/x11-pc-de.map
```
第一行设置模拟的物理内存，meg会将'guest'和'host'内存都设置为32mb

第二三行是设置rom，和真机一样，Bochs也需要系统BIOS和VGA BIOS才能在打开电源或硬件复位后初始化机器，这里就是这两个的位置，这个是bochs安装的默认目录，如果有新的更改可以参考[这里](http://bochs.sourceforge.net/doc/docbook/user/rom-images.html)。

第四行是软盘文件，状态设置为插入（inserted）。
第五行是输入文件，将相关信息输出到文件中。

第六行是鼠标设置为禁用
第七行是键盘设置，这里设置为us键盘布局。

设置好了之后使用bochs -f bochsrc启动模拟：
![](学习一个操作系统-2\2.png)

这里选择默认的6开始模拟：
![](学习一个操作系统-2\3.png)

这里每一个```<bochs:num>```之后都是一个调试命令，简单解释一下：
b 0x7c00 在0x7c00处打一个断点
c 继续执行到断点处，没有断点则一直运行
r 查看数据寄存器和标志寄存器
ps:现版本的bochs没有dump_cpu了,可以用r，fp，mmx，sse，dreg，sreg，creg命令组合来代替。
x /64xb 0x7c00 从0x7c00以16进制显示之后64个地址的内容
n 单步执行，遇到函数则跳过
trace-reg on 让bochs每走一步都显示主要寄存器的值

如果有不清晰的，可以使用help命令查询

最后使用c命令，就可以看到和之前一样的结果了：
![](学习一个操作系统-2\4.png)





